<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="dreamlet">
<title>Error handling • dreamlet</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.2.2/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.2.2/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Error handling">
<meta property="og:description" content="dreamlet">
<meta property="og:image" content="http://DiseaseNeurogenomics.github.io/dreamlet/logo.svg">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-dark navbar-expand-lg bg-primary"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">dreamlet</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.99.32</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../articles/dreamlet.html">Get started</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/cell_covs.html">Modeling continuous cell-level covariates</a>
    <a class="dropdown-item" href="../articles/errors.html">Error handling</a>
    <a class="dropdown-item" href="../articles/h5ad_on_disk.html">Handling large H5AD datasets</a>
    <a class="dropdown-item" href="../articles/mashr.html">mashr analysis after dreamlet</a>
    <a class="dropdown-item" href="../articles/non_lin_eff.html">Testing non-linear effects</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/DiseaseNeurogenomics/dreamlet/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.svg" class="logo" alt=""><h1>Error handling</h1>
                        <h4 data-toc-skip class="author">Developed by <a href="http://gabrielhoffman.github.io/" class="external-link">Gabriel Hoffman</a>
</h4>
            
            <h4 data-toc-skip class="date">Run on 2023-10-24
15:42:43</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/DiseaseNeurogenomics/dreamlet/blob/HEAD/vignettes/errors.Rmd" class="external-link"><code>vignettes/errors.Rmd</code></a></small>
      <div class="d-none name"><code>errors.Rmd</code></div>
    </div>

    
    
<!---

cd /Users/gabrielhoffman/workspace/repos/dreamlet/vignettes

rmarkdown::render("errors.Rmd")


--->
<style>
body {
text-align: justify}
</style>
<p><code><a href="../reference/dreamlet.html">dreamlet()</a></code> evaluates precision-weighted linear (mixed)
models on each gene that passes standard filters. The linear mixed model
used by <code><a href="http://DiseaseNeurogenomics.github.io/variancePartition/reference/dream-method.html" class="external-link">dream()</a></code> can be a little fragile for small sample
sizes and correlated covariates. <code><a href="../reference/dreamlet.html">dreamlet()</a></code> runs
<code><a href="http://DiseaseNeurogenomics.github.io/variancePartition/reference/dream-method.html" class="external-link">variancePartition::dream()</a></code> in the backend for each cell
cluster. <code><a href="http://DiseaseNeurogenomics.github.io/variancePartition/reference/dream-method.html" class="external-link">dream()</a></code> reports model failures for each cell
cluster and <code><a href="../reference/dreamlet.html">dreamlet()</a></code> reports these failures to the user.
<code><a href="../reference/dreamlet.html">dreamlet()</a></code> returns all <strong>successful</strong> model
fits to be used for downstream analysis.</p>
<div class="section level2">
<h2 id="errors-at-the-gene-level">Errors at the gene level<a class="anchor" aria-label="anchor" href="#errors-at-the-gene-level"></a>
</h2>
<p>The most common issue is when <code><a href="../reference/dreamlet.html">dreamlet()</a></code> analysis
succeeds for most genes, but a handful of genes fail in each cell
cluster. These genes can fail if the iterative process of fitting the
linear mixed model does not converge, or if the estimated covariance
matrix that is supposed be positive definite has an eigen-value that is
negative or too close to zero due to rounding errors in floating point
arithmetic.</p>
<p>In these cases, <code><a href="../reference/dreamlet.html">dreamlet()</a></code> stores a summary of these
failures for all cell clusters that is accessible with
<code><a href="../reference/details-methods.html">details()</a></code>. Specific failure messages for each cell cluster
and gene can be extracted using <code><a href="../reference/seeErrors-methods.html">seeErrors()</a></code></p>
<p>Here we demonstrate how <code><a href="../reference/dreamlet.html">dreamlet()</a></code> handles model
failures:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://DiseaseNeurogenomics.github.io/dreamlet" class="external-link">dreamlet</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/HelenaLC/muscat" class="external-link">muscat</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">SingleCellExperiment</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">example_sce</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># create pseudobulk for each sample and cell cluster</span></span>
<span><span class="va">pb</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/aggregateToPseudoBulk.html">aggregateToPseudoBulk</a></span><span class="op">(</span><span class="va">example_sce</span>,</span>
<span>  assay <span class="op">=</span> <span class="st">"counts"</span>,</span>
<span>  cluster_id <span class="op">=</span> <span class="st">"cluster_id"</span>,</span>
<span>  sample_id <span class="op">=</span> <span class="st">"sample_id"</span>,</span>
<span>  verbose <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># voom-style normalization for each cell cluster</span></span>
<span><span class="va">res.proc</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/processAssays.html">processAssays</a></span><span class="op">(</span><span class="va">pb</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">300</span>,<span class="op">]</span>, </span>
<span>  <span class="op">~</span> <span class="va">group_id</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Redundant formula</span></span>
<span><span class="co"># This example is an extreme example of redundancy</span></span>
<span><span class="co"># but more subtle cases often show up in real data</span></span>
<span><span class="va">form</span> <span class="op">=</span> <span class="op">~</span> <span class="va">group_id</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span><span class="op">|</span><span class="va">group_id</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># fit dreamlet model</span></span>
<span><span class="va">res.dl</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/dreamlet.html">dreamlet</a></span><span class="op">(</span><span class="va">res.proc</span>, <span class="va">form</span><span class="op">)</span></span>
<span><span class="co">##  B cells...7.9 secs</span></span>
<span><span class="co">##  CD14+ Monocytes...10 secs</span></span>
<span><span class="co">##  CD4 T cells...9 secs</span></span>
<span><span class="co">##  CD8 T cells...4.4 secs</span></span>
<span><span class="co">##  FCGR3A+ Monocytes...11 secs</span></span>
<span><span class="co">##</span></span>
<span><span class="co">## Of 1,062 models fit across all assays, 96.2% failed</span></span>
<span></span>
<span><span class="co"># summary of models</span></span>
<span><span class="va">res.dl</span></span>
<span><span class="co">## class: dreamletResult </span></span>
<span><span class="co">## assays(5): B cells CD14+ Monocytes CD4 T cells CD8 T cells FCGR3A+ Monocytes</span></span>
<span><span class="co">## Genes:</span></span>
<span><span class="co">##  min: 3 </span></span>
<span><span class="co">##  max: 11 </span></span>
<span><span class="co">## details(7): assay n_retain ... n_errors error_initial</span></span>
<span><span class="co">## coefNames(2): (Intercept) group_idstim</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Of 1,062 models fit across all assays, 96.2% failed</span></span>
<span></span>
<span><span class="co"># summary of models for each cell cluster</span></span>
<span><span class="fu"><a href="../reference/details-methods.html">details</a></span><span class="op">(</span><span class="va">res.dl</span><span class="op">)</span></span>
<span><span class="co">##               assay n_retain                    formula formDropsTerms n_genes n_errors error_initial</span></span>
<span><span class="co">## 1           B cells        4 ~group_id + (1 | group_id)          FALSE     201      190         FALSE</span></span>
<span><span class="co">## 2   CD14+ Monocytes        4 ~group_id + (1 | group_id)          FALSE     269      263         FALSE</span></span>
<span><span class="co">## 3       CD4 T cells        4 ~group_id + (1 | group_id)          FALSE     216      207         FALSE</span></span>
<span><span class="co">## 4       CD8 T cells        4 ~group_id + (1 | group_id)          FALSE     118      115         FALSE</span></span>
<span><span class="co">## 5 FCGR3A+ Monocytes        4 ~group_id + (1 | group_id)          FALSE     258      247         FALSE</span></span>
<span></span>
<span><span class="co"># Extract errors as a tibble</span></span>
<span><span class="fu"><a href="../reference/seeErrors-methods.html">seeErrors</a></span><span class="op">(</span><span class="va">res.dl</span><span class="op">)</span></span>
<span><span class="co">## # A tibble: 1,022 × 3</span></span>
<span><span class="co">##   assay   feature  errorText                                                   </span></span>
<span><span class="co">##   &lt;chr&gt;   &lt;chr&gt;    &lt;chr&gt; </span></span>
<span><span class="co">##  1 B cells ISG15    "Error in lmerTest:::as_lmerModLT(model, devfun, tol = tol)…</span></span>
<span><span class="co">##  2 B cells AURKAIP1 "Error in lmerTest:::as_lmerModLT(model, devfun, tol = tol)…</span></span>
<span></span>
<span><span class="co"># Extract gene-level errors for B cells</span></span>
<span><span class="va">clustID</span> <span class="op">=</span> <span class="st">"B cells"</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/attr.html" class="external-link">attr</a></span><span class="op">(</span><span class="va">res.dl</span><span class="op">[[</span><span class="va">clustID</span><span class="op">]</span><span class="op">]</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span><span class="op">]</span></span>
<span><span class="co">## ISG15 </span></span>
<span><span class="co">##  "Error in lmerTest:::as_lmerModLT(model, devfun, tol = tol): (converted from warning) </span></span>
<span><span class="co">## Model may not have converged with 1 eigenvalue close to zero: 3.2e-11\n" </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## AURKAIP1 </span></span>
<span><span class="co">##  "Error in lmerTest:::as_lmerModLT(model, devfun, tol = tol): (converted from warning) </span></span>
<span><span class="co">## Model may not have converged with 1 eigenvalue close to zero: -2.9e-11\n"  </span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="errors-at-the-cluster-level">Errors at the cluster level<a class="anchor" aria-label="anchor" href="#errors-at-the-cluster-level"></a>
</h2>
<p>Some model failures affect every gene in an assay.
<code><a href="../reference/dreamlet.html">dreamlet()</a></code> tests an initial model fit before analysis of
each gene. If the initial fit fails for a cell cluster, then
<code>details(res.dl)$error_initial</code> will be
<code>TRUE</code>.</p>
</div>
<div class="section level2">
<h2 id="session-info">Session Info<a class="anchor" aria-label="anchor" href="#session-info"></a>
</h2>
<details><pre><code><span><span class="co">## R version 4.3.0 (2023-04-21)</span></span>
<span><span class="co">## Platform: x86_64-apple-darwin22.4.0 (64-bit)</span></span>
<span><span class="co">## Running under: macOS Ventura 13.5</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Matrix products: default</span></span>
<span><span class="co">## BLAS:   /Users/gabrielhoffman/prog/R-4.3.0/lib/libRblas.dylib </span></span>
<span><span class="co">## LAPACK: /usr/local/Cellar/r/4.3.0_1/lib/R/lib/libRlapack.dylib;  LAPACK version 3.11.0</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## locale:</span></span>
<span><span class="co">## [1] en_US.UTF-8/en_US.UTF-8/en_US.UTF-8/C/en_US.UTF-8/en_US.UTF-8</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## time zone: America/New_York</span></span>
<span><span class="co">## tzcode source: internal</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## attached base packages:</span></span>
<span><span class="co">## [1] stats     graphics  grDevices utils     datasets  methods   base     </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## loaded via a namespace (and not attached):</span></span>
<span><span class="co">##  [1] vctrs_0.6.3       cli_3.6.1         knitr_1.43        rlang_1.1.1      </span></span>
<span><span class="co">##  [5] xfun_0.39         stringi_1.7.12    purrr_1.0.1       textshaping_0.3.6</span></span>
<span><span class="co">##  [9] jsonlite_1.8.5    glue_1.6.2        rprojroot_2.0.3   htmltools_0.5.5  </span></span>
<span><span class="co">## [13] ragg_1.2.5        sass_0.4.6        rmarkdown_2.22    evaluate_0.21    </span></span>
<span><span class="co">## [17] jquerylib_0.1.4   fastmap_1.1.1     yaml_2.3.7        lifecycle_1.0.3  </span></span>
<span><span class="co">## [21] memoise_2.0.1     stringr_1.5.0     compiler_4.3.0    fs_1.6.2         </span></span>
<span><span class="co">## [25] systemfonts_1.0.4 digest_0.6.33     R6_2.5.1          magrittr_2.0.3   </span></span>
<span><span class="co">## [29] bslib_0.4.2       tools_4.3.0       pkgdown_2.0.7     cachem_1.0.8     </span></span>
<span><span class="co">## [33] desc_1.4.2</span></span></code></pre>
</details>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by <a href="http://gabrielhoffman.github.io" class="external-link">Gabriel Hoffman</a>.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
